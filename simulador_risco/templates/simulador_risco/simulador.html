{% extends "bases.html" %}

{% block title %}Simulador de Risco Sanitário SES/MG - Lummia Consultoria{% endblock %}

{% block content %}
<div class="card shadow-lg border-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0"><i class="bi bi-activity me-2"></i> Simulador de Risco Sanitário - SES/MG</h2>
        <button id="btnLimpar" class="btn btn-sm btn-outline-light" style="display: none;"><i class="bi bi-arrow-clockwise me-1"></i> Nova Análise</button>
    </div>
    <div class="card-body p-lg-4">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <p class="card-text text-muted mb-0">Baseado na Resolução SES/MG N° 10.601, de 21 de Outubro de 2025.</p>
            <div class="form-check form-switch fs-5" data-bs-toggle="tooltip" data-bs-placement="top" title="Ative esta opção se a empresa for um Microempreendedor Individual para ver as regras específicas.">
                <input class="form-check-input" type="checkbox" role="switch" id="meiSwitch">
                <label class="form-check-label" for="meiSwitch"><strong>É MEI?</strong></label>
            </div>
        </div>

        <div id="inputArea">
            <div class="row g-3 align-items-start">
                <div class="col-lg-6">
                    <label for="cnpjInput" class="form-label"><strong>1. Consulte por CNPJ (Recomendado)</strong></label>
                    <div class="input-group">
                        <input type="text" id="cnpjInput" class="form-control" placeholder="00.000.000/0001-00" maxlength="18">
                        <button class="btn btn-primary" id="btnConsultarCnpj" type="button">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                            <i class="bi bi-search"></i> Consultar
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <label for="cnaeSearch" class="form-label"><strong>2. Ou adicione CNAEs manualmente</strong></label>
                    <div class="input-group">
                        <select id="cnaeSearch" class="form-select" data-placeholder="Digite 3+ caracteres do código ou descrição..."></select>
                        <button class="btn btn-success" id="btnAddCnae" type="button" title="Adicionar CNAE à análise"><i class="bi bi-plus-lg"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensagem de proteção reCAPTCHA v3 -->
        <div class="text-center my-3">
            <small class="text-muted">
                <i class="bi bi-shield-check me-1"></i>
                Este site é protegido pelo reCAPTCHA e a 
                <a href="https://policies.google.com/privacy" target="_blank">Política de Privacidade</a> e os 
                <a href="https://policies.google.com/terms" target="_blank">Termos de Serviço</a> do Google se aplicam.
            </small>
        </div>

        <hr class="my-4">

        <div id="loading" class="text-center my-4" style="display: none;">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-2 fs-5">Consultando dados...</p>
        </div>

        <div id="resultsArea" style="display: none;">
            <div id="empresaInfo" class="card bg-light mb-4" style="display: none;"></div>
            <h3 class="mb-3">Resultado da Análise</h3>
            <div id="resultadoFinal" class="alert d-flex align-items-center" role="alert">
                <h4 class="alert-heading mb-0 me-3">Risco da Empresa:</h4>
                <strong id="riscoFinalTexto" class="fs-3"></strong>
            </div>
            <div id="cnaeListContainer" class="mb-4"></div>

            <div id="adSlot1" class="text-center my-4" style="display: none; min-height: 100px;">
                <p class="small text-muted mb-2">Publicidade</p>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-1088592580749913"
                     data-ad-slot="7722489643"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
        
        <div class="alert alert-warning mt-4 small">
            <strong>Aviso Legal:</strong> Este simulador não substitui a consulta oficial. A classificação final pode variar conforme interpretação da Vigilância Sanitária (VISA) e prevalece sempre o maior nível de risco.
            <br>
            Para informações definitivas, <strong>procure a Vigilância Sanitária do seu município.</strong>
            <hr class="my-2">
            Encontrou um erro ou tem uma sugestão? Envie para: <a href="mailto:guilherme-02-08@hotmail.com">guilherme-02-08@hotmail.com</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SCRIPT DO GOOGLE RECAPTCHA V3 -->
<script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_PUBLIC_KEY }}&hl=pt-BR"></script>

<script>
    // Variável global para armazenar a instância do reCAPTCHA
    const RECAPTCHA_SITE_KEY = '{{ RECAPTCHA_PUBLIC_KEY }}';
    
    // Função para obter token do reCAPTCHA v3
    async function getRecaptchaToken(action) {
        try {
            const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: action });
            return token;
        } catch (error) {
            console.error('Erro ao obter token reCAPTCHA:', error);
            alert('Erro ao validar segurança. Por favor, recarregue a página.');
            return null;
        }
    }

    function inicializarTooltips() {
        const oldTooltips = document.querySelectorAll('.tooltip');
        oldTooltips.forEach(tt => tt.remove());
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    document.addEventListener('DOMContentLoaded', () => {
        const ui = {
            cnpjInput: document.getElementById('cnpjInput'),
            btnConsultarCnpj: document.getElementById('btnConsultarCnpj'),
            cnaeSearch: $('#cnaeSearch'),
            btnAddCnae: document.getElementById('btnAddCnae'),
            btnLimpar: document.getElementById('btnLimpar'),
            loading: document.getElementById('loading'),
            inputArea: document.getElementById('inputArea'),
            resultsArea: document.getElementById('resultsArea'),
            empresaInfo: document.getElementById('empresaInfo'),
            resultadoFinal: document.getElementById('resultadoFinal'),
            riscoFinalTexto: document.getElementById('riscoFinalTexto'),
            cnaeListContainer: document.getElementById('cnaeListContainer'),
            meiSwitch: document.getElementById('meiSwitch'),
            adSlot1: document.getElementById('adSlot1'),
        };

        let state = {
            cnaesAnalisados: new Set(),
            dadosCNAEs: [],
            dadosPerguntas: [],
            respostasCNAE: {},
        };
        
        const CONSTS = {
            RISCO_MAP: {'NA': 0, 'I': 1, 'II': 2, 'III': 3},
            CORES: {0: 'info', 1: 'success', 2: 'warning', 3: 'danger'},
            TITULOS: {
                0: 'N/A (Não se Aplica)', 1: 'Nível de Risco I',
                2: 'Nível de Risco II', 3: 'Nível de Risco III'
            },
            DESCRICOES: {
                0: 'Atividade não regulada pela vigilância sanitária, dispensada de alvará sanitário.',
                1: 'Baixo Risco: Dispensado de atos públicos de liberação (licenciamento) para início da operação, sujeito a fiscalizações posteriores.',
                2: 'Médio Risco: Requer licenciamento sanitário simplificado antes do início das atividades, sujeito a fiscalizações posteriores.',
                3: 'Alto Risco: EXIGE vistoria prévia e licenciamento sanitário antes do início do funcionamento.'
            }
        };

        const CONSTS_MEI = {
            TITULOS: {
                0: 'N/A (Não se Aplica)',
                1: 'Nível de Risco I (MEI)',
                2: 'Nível de Risco II (MEI)',
                3: 'Nível de Risco III (MEI)'
            },
            DESCRICOES: {
                0: 'Atividade não regulada pela vigilância sanitária.',
                1: 'Baixo Risco (MEI): Dispensado de alvará sanitário e de taxas para início da operação.',
                2: 'Médio Risco (MEI): Dispensado de alvará sanitário para início da operação, mas deve seguir as normas sanitárias. Isento de taxas.',
                3: 'Alto Risco (MEI): Abertura e funcionamento EXIGEM vistoria prévia e licenciamento sanitário. O MEI possui apenas isenção das taxas, não do processo de licenciamento.'
            }
        };

        ui.cnaeSearch.select2({
            theme: 'bootstrap-5',
            ajax: {
                url: '{% url "simulador_risco:api_buscar_cnae" %}',
                dataType: 'json', delay: 250, data: params => ({ termo: params.term }),
                processResults: data => ({ results: data }), cache: true
            },
            minimumInputLength: 3
        });

        ui.cnpjInput.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g,'').replace(/^(\d{2})(\d)/,'$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/,'$1.$2.$3').replace(/\.(\d{3})(\d)/,'.$1/$2').replace(/(\d{4})(\d)/,'$1-$2');
            e.target.value = v;
        });
        
        ui.btnLimpar.addEventListener('click', resetApp);
        ui.btnConsultarCnpj.addEventListener('click', handleCnpjSearch);
        ui.btnAddCnae.addEventListener('click', handleAddCnae);
        ui.meiSwitch.addEventListener('change', () => { if (state.dadosCNAEs.length > 0) calcularRiscoFinal(); });
        inicializarTooltips();

        function resetApp() {
            ui.cnpjInput.value = '';
            ui.cnaeSearch.val(null).trigger('change');
            ui.resultsArea.style.display = 'none';
            ui.inputArea.style.display = 'block';
            ui.btnLimpar.style.display = 'none';
            ui.adSlot1.style.display = 'none';
            state.cnaesAnalisados.clear();
            ui.cnaeListContainer.innerHTML = '';
            ui.empresaInfo.style.display = 'none';
        }

        async function handleCnpjSearch() {
            const cnpj = ui.cnpjInput.value.replace(/\D/g, '');
            if (cnpj.length !== 14) { 
                alert('Digite um CNPJ válido com 14 dígitos.'); 
                return; 
            }

            // Obter token reCAPTCHA v3 para ação 'consultar_cnpj'
            const recaptchaToken = await getRecaptchaToken('consultar_cnpj');
            if (!recaptchaToken) return;

            toggleLoading(true, ui.btnConsultarCnpj);
            try {
                const response = await fetch(`/simulador-risco-ses/api/consultar-cnpj/${cnpj}/?g-recaptcha-response=${recaptchaToken}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || 'Falha ao consultar CNPJ. Verifique o número e tente novamente.');
                }
                const data = await response.json();
                renderizarInfoEmpresa(data.empresa_data);
                const cnaes = (data.cnaes || []).filter(c => c && c !== "0").map(String);
                state.cnaesAnalisados = new Set(cnaes);
                await consultarCnaes();
            } catch (error) {
                alert(error.message);
                ui.resultsArea.style.display = 'none';
            } finally {
                toggleLoading(false, ui.btnConsultarCnpj);
            }
        }

        function handleAddCnae() {
            const cnaeSelecionado = ui.cnaeSearch.val();
            if (cnaeSelecionado) {
                state.cnaesAnalisados.add(cnaeSelecionado);
                consultarCnaes();
                ui.cnaeSearch.val(null).trigger('change');
            }
        }

        async function consultarCnaes() {
            const cnaesLista = [...state.cnaesAnalisados];
            if (cnaesLista.length === 0) {
                renderizarListaCNAEs();
                calcularRiscoFinal();
                return;
            }

            // Obter token reCAPTCHA v3 para ação 'consultar_cnaes'
            const recaptchaToken = await getRecaptchaToken('consultar_cnaes');
            if (!recaptchaToken) return;

            toggleLoading(true);
            try {
                const response = await fetch('{% url "simulador_risco:api_consultar_cnaes" %}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cnaes: cnaesLista, 'g-recaptcha-response': recaptchaToken })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || 'Falha ao analisar CNAEs.');
                }
                const data = await response.json();
                state.dadosCNAEs = data.cnaes_processados;
                state.dadosPerguntas = data.perguntas_necessarias;
                state.respostasCNAE = {};
                renderizarListaCNAEs();
                calcularRiscoFinal();
                ui.resultsArea.style.display = 'block';
                ui.btnLimpar.style.display = 'block';
                ui.adSlot1.style.display = 'block';
            } catch (error) {
                alert(error.message);
                ui.resultsArea.style.display = 'none';
            } finally {
                toggleLoading(false);
            }
        }

        function renderizarListaCNAEs() {
            state.dadosCNAEs.sort((a, b) => b.ordem - a.ordem);
            let html = state.dadosCNAEs.length > 0 ? '<h5 class="mb-3">CNAEs Identificados:</h5><div class="list-group">' : '';
            
            state.dadosCNAEs.forEach(cnae => {
                const textColor = ['warning', 'info', 'light'].includes(cnae.cor) ? 'text-dark' : '';
                
                let riscoBaseDisplay = cnae.risco_base === 'NA' ? 'N/A' : cnae.risco_base;
                if (cnae.risco_base === 'III' && !cnae.dispensado_projeto) {
                    riscoBaseDisplay += '+';
                }

                const hasQuestions = cnae.risco_base === 'P';
                const collapseId = `collapse-${cnae.codigo}`;
                const itemClass = hasQuestions ? 'list-group-item list-group-item-action' : 'list-group-item';
                const collapseAttrs = hasQuestions ? `data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false" aria-controls="${collapseId}"` : '';

                html += `<div class="${itemClass}" id="cnae-item-${cnae.codigo}">
                            <div class="d-flex w-100 justify-content-between align-items-center" ${collapseAttrs}>
                                <h6 class="mb-1">${cnae.codigo_formatado} - ${cnae.descricao}</h6>
                                <span class="badge bg-${cnae.cor} ${textColor} rounded-pill p-2" data-bs-toggle="tooltip" data-bs-placement="top" title="${cnae.tooltip}">${riscoBaseDisplay}</span>
                            </div>`;

                if (hasQuestions) {
                    html += `<div class="collapse" id="${collapseId}">
                                <div class="mt-3 p-3 bg-light rounded">`;
                    cnae.perguntas_nums.forEach(numPergunta => {
                        const pergunta = state.dadosPerguntas.find(p => p.numero === numPergunta);
                        if (pergunta) {
                            const radioName = `p_${pergunta.numero}_cnae_${cnae.codigo}`;
                            const opcoesHtml = pergunta.opcoes.map(opcao => {
                                const isChecked = state.respostasCNAE[cnae.codigo]?.[pergunta.numero] === opcao.risco ? 'checked' : '';
                                return `<div class="form-check form-check-inline">
                                            <input class="form-check-input cnae-pergunta-radio" type="radio" name="${radioName}" value="${opcao.risco}" data-num="${pergunta.numero}" data-cnae-code="${cnae.codigo}" ${isChecked}>
                                            <label class="form-check-label">${opcao.texto}</label>
                                        </div>`;
                            }).join('');
                            html += `<div class="mb-2"><p class="mb-1 small"><strong>Pergunta ${pergunta.numero}:</strong> ${pergunta.texto}</p>${opcoesHtml}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }
                html += '</div>';
            });
            html += state.dadosCNAEs.length > 0 ? '</div>' : '';
            
            ui.cnaeListContainer.innerHTML = html;

            ui.cnaeListContainer.querySelectorAll('.cnae-pergunta-radio').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const { num, cnaeCode } = e.target.dataset;
                    if (!state.respostasCNAE[cnaeCode]) state.respostasCNAE[cnaeCode] = {};
                    state.respostasCNAE[cnaeCode][num] = e.target.value;
                    
                    atualizarRiscoCNAEIndividual(cnaeCode);
                    calcularRiscoFinal();
                });
            });

            inicializarTooltips();
        }
        
        function atualizarRiscoCNAEIndividual(cnaeCode) {
            const cnaeItem = state.dadosCNAEs.find(c => c.codigo === cnaeCode);
            if (!cnaeItem || cnaeItem.risco_base !== 'P') return;

            let riscoMaxLocal = 0;
            const todasRespondidas = cnaeItem.perguntas_nums.every(num => state.respostasCNAE[cnaeCode]?.[num]);

            if (todasRespondidas) {
                cnaeItem.perguntas_nums.forEach(num => {
                    const respostaRisco = state.respostasCNAE[cnaeCode][num];
                    riscoMaxLocal = Math.max(riscoMaxLocal, CONSTS.RISCO_MAP[respostaRisco] || 0);
                });
            }
            
            const badge = document.querySelector(`#cnae-item-${cnaeCode} .badge`);
            if (badge) {
                let novoRiscoTexto = todasRespondidas ? CONSTS.TITULOS[riscoMaxLocal].replace('Nível de Risco ', '').replace('N/A (Não se Aplica)', 'N/A') : 'P';
                let novoTooltip = todasRespondidas ? CONSTS.DESCRICOES[riscoMaxLocal] : cnaeItem.tooltip;
                
                if (riscoMaxLocal === 3 && !cnaeItem.dispensado_projeto) {
                    novoRiscoTexto += '+';
                    novoTooltip = 'Nível de Risco III com exigência de projeto arquitetônico aprovado';
                }

                const novaCor = todasRespondidas ? CONSTS.CORES[riscoMaxLocal] : 'secondary';
                const novoTextColor = ['warning', 'info'].includes(novaCor) ? 'text-dark' : '';

                badge.textContent = novoRiscoTexto;
                badge.className = `badge bg-${novaCor} ${novoTextColor} rounded-pill p-2`;
                
                const tooltipInstance = bootstrap.Tooltip.getInstance(badge);
                if (tooltipInstance) {
                    tooltipInstance.setContent({ '.tooltip-inner': novoTooltip });
                }
            }
            
            if(todasRespondidas) {
                const collapseElement = document.getElementById(`collapse-${cnaeCode}`);
                if(collapseElement) {
                    const bsCollapse = bootstrap.Collapse.getInstance(collapseElement) || new bootstrap.Collapse(collapseElement, {toggle: false});
                    bsCollapse.hide();
                }
            }
        }
        
        function calcularRiscoFinal() {
            let riscoMaxGlobal = 0;
            let projetoObrigatorio = false;
            const isMei = ui.meiSwitch.checked;

            state.dadosCNAEs.forEach(cnae => {
                let riscoAtualNum = 0;
                const cnaeRespostas = state.respostasCNAE[cnae.codigo];
                if (cnae.risco_base === 'P' && cnaeRespostas) {
                    let riscoMaxLocal = 0;
                    if (cnae.perguntas_nums.every(num => cnaeRespostas[num])) {
                        cnae.perguntas_nums.forEach(num => {
                            riscoMaxLocal = Math.max(riscoMaxLocal, CONSTS.RISCO_MAP[cnaeRespostas[num]] || 0);
                        });
                        riscoAtualNum = riscoMaxLocal;
                    }
                } else if (cnae.risco_base !== 'P') {
                    riscoAtualNum = CONSTS.RISCO_MAP[cnae.risco_base] || 0;
                }
                
                if (riscoAtualNum > riscoMaxGlobal) {
                    riscoMaxGlobal = riscoAtualNum;
                    projetoObrigatorio = (riscoAtualNum === 3 && !cnae.dispensado_projeto);
                } else if (riscoAtualNum === 3 && riscoMaxGlobal === 3) {
                    if (!cnae.dispensado_projeto) {
                        projetoObrigatorio = true;
                    }
                }
            });
            
            const pendentes = state.dadosCNAEs.some(cnae => cnae.risco_base === 'P' && !cnae.perguntas_nums.every(num => state.respostasCNAE[cnae.codigo]?.[num]));
            
            const titulos = isMei ? CONSTS_MEI.TITULOS : CONSTS.TITULOS;
            const descricoes = isMei ? CONSTS_MEI.DESCRICOES : CONSTS.DESCRICOES;

            const corFinal = CONSTS.CORES[riscoMaxGlobal];
            let tituloFinal = titulos[riscoMaxGlobal];
            let descricaoFinal = descricoes[riscoMaxGlobal];

            if (riscoMaxGlobal === 3 && projetoObrigatorio) {
                tituloFinal += '+';
                descricaoFinal += ' O sinal de "+" indica a provável necessidade de aprovação de projeto arquitetônico antes do licenciamento.';
            }

            const textColor = ['warning', 'info'].includes(corFinal) ? 'text-dark' : '';
            
            ui.resultadoFinal.className = `alert alert-${corFinal} d-flex align-items-center ${textColor}`;
            ui.riscoFinalTexto.innerHTML = `${tituloFinal} <i class="bi bi-info-circle-fill ms-2" style="cursor: pointer;" data-bs-toggle="tooltip" data-bs-placement="top" title="${descricaoFinal}"></i>`;
            
            if (pendentes) { ui.riscoFinalTexto.innerHTML += ` <span class="badge bg-dark ms-2">PENDENTE</span>`; }
            inicializarTooltips();
        }
        
        function toggleLoading(isLoading, button = null) {
            ui.loading.style.display = isLoading ? 'block' : 'none';
            if (isLoading) { ui.resultsArea.style.display = 'none'; }
            if(button) {
                button.disabled = isLoading;
                const spinner = button.querySelector('.spinner-border');
                const icon = button.querySelector('.bi');
                if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
                if (icon) icon.style.display = isLoading ? 'none' : 'inline-block';
            }
        }
        
        function renderizarInfoEmpresa(data) {
            if (!data || !data.razao_social) { ui.empresaInfo.style.display = 'none'; return; }
            ui.empresaInfo.innerHTML = `<div class="card-body"><h5 class="card-title">${data.razao_social}</h5><p class="card-text mb-1"><strong>Nome Fantasia:</strong> ${data.nome_fantasia || 'N/A'}</p><p class="card-text"><strong>Situação:</strong> ${data.situacao_cadastral}</p></div>`;
            ui.empresaInfo.style.display = 'block';
        }
    });
</script>
{% endblock %}
